# Notes:
# - Docker containers with R, etc. provided by rocker.  See <https://hub.docker.com/r/rocker/verse>.
# - Builds attempted for 4.0.5, and the *latest* R edition supported by rocker.

version: 2.1

workflows:

  version: 2
  Prepare-All-R-Editions:
    jobs:
      - Build-for-r4_0_5
      - Build-for-rLATEST

jobs:

  Build-for-r4_0_5:
    docker:
      - image: rocker/verse:4.0.5

    steps:
      - checkout
      - run:
          name: Review checkout
          command: ls -la

      - run:
          name: Install Linux dependencies
          command: |
            sudo apt-get update -y
            sudo apt-get install -yq texlive-fonts-recommended
            sudo apt-get install -yq texlive-fonts-extra

      - run:
          name: Install R dependencies
          command: |
            R -e 'install.packages("shiny", repos = "https://cran.rstudio.com/")'
            R -e 'install.packages("bs4Dash", repos = "https://cran.rstudio.com/")'
            R -e 'install.packages(c("shinyWidgets", "yaml", "DT", "writexl", "fresh", "miniUI", "shinyFeedback"))'
            R -e 'install.packages(c("canvasXpress", "waiter", "shinyjs", "openxlsx", "spelling", "colourpicker", "lifecycle"))'
            R -e 'install.packages("reactable")'
            R -e 'install.packages("openxlsx2", repos = "https://cloud.r-project.org")'

      - run:
          name: Session information and installed package versions
          command: |
            Rscript -e 'sessionInfo()'
            Rscript -e 'installed.packages()[, c("Package", "Version")]'
            Rscript -e 'rmarkdown::pandoc_version()'

      - run:
          name: Build package
          command: R CMD build .


      - run:
          name: Direct File Testing (Most Reliable)
          command: |
            # Test files one by one with direct R execution
            cd tests/testthat

            echo "=== Available test files ==="
            ls -la test-*.R

            echo "=== Testing each file ==="

            # Loop through each test file
            for test_file in test-*.R; do
                echo ""
                echo "========================================="
                echo "Testing: $test_file"
                echo "========================================="

                # Create a simple test runner for this file
                cat > run_single_test.R << EOF
                options(crayon.enabled = FALSE, cli.ansi = FALSE)
                Sys.setenv(NO_COLOR = "1")

                cat("Loading testthat...\n")
                library(testthat)

                cat("Testing file: $test_file\n")

                tryCatch({
                  test_file("$test_file")
                  cat("SUCCESS: $test_file completed\n")
                }, error = function(e) {
                  cat("FAILURE in $test_file\n")
                  cat("Error message:", conditionMessage(e), "\n")
                  quit(status = 1)
                })
              EOF

                # Run the test
                if Rscript run_single_test.R; then
                  echo "✅ PASSED: $test_file"
                else
                  echo "❌ FAILED: $test_file"
                  echo "This is the problematic file!"
                  rm run_single_test.R
                  exit 1
                fi

                rm run_single_test.R
              done

              echo "All test files passed individually!"}
                     "

      - run:
          name: Check package
          command: |
            # Install suggested packages
            R -e 'install.packages("png")'
            # Perform package check
            R CMD check *tar.gz


  Build-for-rLATEST:
    docker:
      - image: rocker/verse:latest

    steps:
      - checkout
      - run:
          name: Review checkout
          command: ls -la

      - run:
          name: Install Linux dependencies
          command: |
            sudo apt-get update -y
            sudo apt-get install -yq texlive-fonts-recommended
            sudo apt-get install -yq texlive-fonts-extra

      - run:
          name: Install R dependencies
          command: |
            R -e 'install.packages(c("bs4Dash", "shinyWidgets", "yaml", "DT", "writexl", "fresh", "miniUI", "shinyFeedback"))'
            R -e 'install.packages(c("canvasXpress", "waiter", "shinyjs", "openxlsx",  "openxlsx2", "spelling", "colourpicker", "lifecycle"))'
            R -e 'install.packages("covr")'
            R -e 'install.packages("reactable")'

      - run:
          name: Session information and installed package versions
          command: |
            Rscript -e 'sessionInfo()'
            Rscript -e 'installed.packages()[, c("Package", "Version")]'
            Rscript -e 'rmarkdown::pandoc_version()'

      - run:
          name: Build package
          command: R CMD build .

      - run:
          name: Check coverage
          command: Rscript -e 'library(covr); codecov(quiet = FALSE)'

      - run:
          name: Check package
          command: |
            # Install suggested packages
            R -e 'install.packages("png")'
            # Perform package check
            R CMD check *tar.gz

